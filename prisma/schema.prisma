// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Platform enum for type-safe platform identification
enum Platform {
  KALSHI
  POLYMARKET
}

// Placeholder model for initial migration (required for Prisma to generate migration)
// This will be removed in Story 1.4 when real tables are added
model SystemMetadata {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_metadata")
}

// Order book snapshots for audit trail and compliance (7-year retention)
// DESIGN DECISION: Store full depth (bids/asks arrays as JSON) not just best prices
// - Justification: Epic 3's edge calculator needs "liquidity depth at execution prices" (FR-AD-02)
// - Storage cost: ~1-2KB per snapshot vs ~100 bytes for best-only
// - Query pattern: Primarily time-series append, rare queries, acceptable trade-off
model OrderBookSnapshot {
  id              String   @id @default(uuid())
  platform        Platform // Platform enum: KALSHI | POLYMARKET
  contract_id     String   // Platform's contract identifier
  bids            Json     // PriceLevel[] serialized: [{price: 0.60, quantity: 1000}, ...]
  asks            Json     // PriceLevel[] serialized: [{price: 0.65, quantity: 800}, ...]
  sequence_number Int?     // Optional WebSocket sequence tracking
  created_at      DateTime @default(now()) @db.Timestamptz

  @@index([platform, contract_id, created_at])
  @@index([created_at]) // For retention policy cleanup (7-year window)
  @@map("order_book_snapshots")
}

// Platform health logs for observability and degradation analysis
model PlatformHealthLog {
  id                 String   @id @default(uuid())
  platform           Platform // Platform enum: KALSHI | POLYMARKET
  status             String   // "healthy" | "degraded" | "disconnected" (NOT "offline")
  last_update        DateTime @db.Timestamptz
  response_time_ms   Float?   // p95 latency
  connection_state   String   // From connector.getHealth() metadata
  created_at         DateTime @default(now()) @db.Timestamptz

  @@index([platform, created_at])
  @@index([created_at])
  @@map("platform_health_logs")
}

// Contract match pairs tracking operator-approved cross-platform matches
model ContractMatch {
  matchId                    String    @id @default(uuid()) @map("match_id")
  polymarketContractId       String    @map("polymarket_contract_id")
  kalshiContractId           String    @map("kalshi_contract_id")
  polymarketDescription      String?   @map("polymarket_description")
  kalshiDescription          String?   @map("kalshi_description")
  operatorApproved           Boolean   @default(false) @map("operator_approved")
  operatorApprovalTimestamp  DateTime? @map("operator_approval_timestamp") @db.Timestamptz
  operatorRationale          String?   @map("operator_rationale")
  firstTradedTimestamp       DateTime? @map("first_traded_timestamp") @db.Timestamptz
  totalCyclesTraded          Int       @default(0) @map("total_cycles_traded")
  createdAt                  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                  DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([polymarketContractId, kalshiContractId])
  @@index([operatorApproved])
  @@map("contract_matches")
}

// Risk state singleton for tracking position counts and capital deployment
model RiskState {
  id                    String    @id @default(uuid()) @map("id")
  singletonKey          String    @unique @default("default") @map("singleton_key")
  dailyPnl              Decimal   @default(0) @map("daily_pnl") @db.Decimal(20, 8)
  openPositionCount     Int       @default(0) @map("open_position_count")
  lastResetTimestamp    DateTime? @map("last_reset_timestamp") @db.Timestamptz
  totalCapitalDeployed  Decimal   @default(0) @map("total_capital_deployed") @db.Decimal(20, 8)
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@map("risk_states")
}
